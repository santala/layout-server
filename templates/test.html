<!DOCTYPE html>
<html>
<head>
    <title>Hello {{ name }}</title>
    <style>

canvas {
    display: block;
    float: left;
    width: 50%;
    height: auto;
}

form {
    clear: both;
}

    </style>
    <script>

async function submitLayoutEngine() {
    console.log("Submitting to layout engine…");
    try {
        console.log("Parsing layout…");
        let layout = await readJSON(document.getElementById("layoutEngineFile"));

        drawLayout("layoutEngineInput", layout.layouts[0]);

        console.log("Uploading layout…");
        let response = await fetch("{{ url_for('optimize_layout') }}", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(layout), // body data type must match "Content-Type" header
        });
        console.log(response);

        if (response.ok) {
            console.log("Parsing response…");
            let optimizedLayout = (await response.json()).layout;
            console.log(optimizedLayout);
            drawLayout("layoutEngineOutput", optimizedLayout);
        }

    } catch (e) {
        console.log(e);
    }
}

function drawLayout(canvasId, layout) {
    console.log(canvasId, layout);
    let canvas = document.getElementById(canvasId);
    canvas.width = layout.canvasWidth;
    canvas.height = layout.canvasHeight;

    let ctx = canvas.getContext("2d");
    ctx.fillStyle = "lightgray";
    ctx.strokeStyle = "gray";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = "blue";
    ctx.font = "bold 48px sans-serif";
    ctx.textBaseline = "hanging";

    for (let element of layout.elements) {
        ctx.fillStyle = "lightblue";
        ctx.fillRect(element.x, element.y, element.width, element.height);
        ctx.strokeRect(element.x, element.y, element.width, element.height);
        ctx.fillStyle = "black";
        ctx.fillText(element.id, element.x, element.y, element.width);
        console.log(element);
    }
}

function readJSON(input) {
    return new Promise((resolve, reject) => {
        if (typeof window.FileReader !== 'function') {
            alert("The file API isn't supported on this browser yet.");
            reject();
            return;
        }
        if (!input.files) {
            alert("This browser doesn't seem to support the `files` property of file inputs.");
            reject();
            return;
        } else if (!input.files[0]) {
            alert("Please select a file before clicking 'Load'");
            reject();
            return;
        }
        let reader = new FileReader();
        reader.onload = () => {
            resolve(JSON.parse(reader.result));
        };
        reader.readAsText(input.files[0]);
    });
}

    </script>
</head>
<body>

<form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
    <fieldset>
        <legend>Layout Difference</legend>
        <label>Layout 1 <input type="file" name="layoutA" required /></label>
        <label>Layout 2 <input type="file" name="layoutB" required /></label>
        <input type="submit" />
    </fieldset>
</form>

<form id="layoutEngineForm" onsubmit="event.preventDefault()">
    <fieldset>
        <legend>Layout Engine</legend>
        <label>Layout <input type="file" id="layoutEngineFile" name="layout" /></label>
        <input type="submit" />
    </fieldset>
</form>

<canvas id="layoutEngineInput"></canvas>
<canvas id="layoutEngineOutput"></canvas>

<form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
    <fieldset>
        <legend>Bad Form</legend>
        <input type="file" name="wrong_name" />
        <input type="submit" />
    </fieldset>
</form>

<pre>{{ message }}</pre>

<script>

document.getElementById("layoutEngineForm").addEventListener("submit", (event) => {
    event.preventDefault();
    submitLayoutEngine();
}, false);

</script>

</body>
</html>